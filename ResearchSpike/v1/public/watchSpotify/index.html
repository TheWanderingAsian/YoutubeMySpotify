<html>
<body>
  <div id="player"></div>  
 </body>
</html>

<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script>
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var ScriptTag = document.getElementsByTagName('script')[0];
    ScriptTag.parentNode.insertBefore(tag, ScriptTag);

    var player; 
    function onYouTubeIframeAPIReady() {                      
        player = new YT.Player('player', {
        height: '390',
        width: '640',
        videoId : '0',                 
        events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
        }      
        });
    }        
    function onPlayerReady(event) {                                        
        event.target.playVideo();
    }       
    function onPlayerStateChange(event) {   
        if (event.data == YT.PlayerState.ENDED) {   
        player.loadVideoById ('');
        }       
    }

    function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
            q = window.location.hash.substring(1);
        while ( e = r.exec(q)) {
            hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
    }
    
    var params = getHashParams();
    var access_token = params.access_token,
        refresh_token = params.refresh_token,
        error = params.error;
    

    var lastSongId;
    function getCurrentSong(){
        $.ajax({
        url: 'https://api.spotify.com/v1/me/player/currently-playing',
        headers: {
            'Authorization': 'Bearer ' + access_token
        },
        success: function(response) {
            console.log(response)
            if (response.item.id == lastSongId){
                return;
            }
            
            lastSongId = response.item.id;
            var artistNames = "";
            for (var i = 0; i<response.item.artists.length;i++){
                artistNames = artistNames + response.item.artists[i].name
                if (i < response.item.artists.length - 1){
                    artistNames = artistNames + "+"
                }
            }
            getCurrentVideo(response.item.name, response.item.album.name, artistNames, response.item.duration_ms, response.progress_ms);
        }   
    });
    }

    function updatePlayer(newId, startAt){
        try{
            player.loadVideoById(newId, () => {
                player.seekTo(startAt);
            });
        }
        catch(e){
            // updatePlayer(newId);
        }
    }

    function getCurrentVideo(songName, albumName, artistName, songDuration, songProgress){
        console.log("Finding video for ", albumName, ': ', songName, '(dur.', songDuration, '@', songProgress, ')')
        $.ajax({
            url: '/getVideoId',
            type: 'POST',
            dataType: 'json',
            contentType: 'application/x-www-form-urlencoded',
            data: {
                'songName': songName,
                'albumName': albumName,
                'artistName': artistName,
                'songDuration': songDuration,
                'songProgress': songProgress,
            },
            success: function(response) {
                console.log('videoIdres,', response.videoId)
                // nextVideoId = response.videoId;
                updatePlayer(response.videoId, Math.round(songProgress / 1000))
            }   
        });
    }


    function main(){
        setTimeout(() => {
            getCurrentSong();
        }, 500)

        update()
    }

    function update(){
        setTimeout(() => {
            getCurrentSong();
            update();
        }, 2000)
    }

    main();
</script>